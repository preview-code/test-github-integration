<!--
@license
Copyright (c) 2017 Preview-Code. All rights reserved.
This code may only be used under the BSD style license found in LICENSE.txt
-->
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">

<!--
Authentication endpoint for Firebase to handle login logic and storage
of the GitHub oAuth token.
-->
<dom-module id="firebase-authentication">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <firebase-app auth-domain="preview-code.firebaseapp.com"
        name="preview-code"
        database-url="https://preview-code.firebaseio.com/"
        api-key="AIzaSyALQRHW7FvJXnjli-QSGgX8eI6FEhCJ3Bg">
    </firebase-app>
    <firebase-auth id="auth"
        app-name="preview-code"
        provider="github"
        signed-in="{{signedIn}}"
        status-known="{{statusKnown}}"
        user="{{user}}"
        ></firebase-auth>
    <iron-localstorage name="token-storage"
        value="{{_tokens}}"
        on-iron-localstorage-load-empty="_setEmptyTokens"
      ></iron-localstorage>
  </template>
  <script>
  /*global firebase*/
    Polymer({
      is: 'firebase-authentication',
      properties: {
        /**
         * True if the firebase authentication result is being fetched
         * and the redirect is happening.
         * @type {Boolean}
         */
        loading: {
          type: Boolean,
          notify: true
        },

        user: {
          type: Object,
          notify: true
        },

        signedIn: Boolean,
        _tokens: Object,
        statusKnown: Boolean
      },

      observers: [
        '_onSignInChange(signedIn, statusKnown)'
      ],

      attached: function() {
        this._parseSuccesfulResult = this._parseSuccesfulResult.bind(this);
      },

      /**
       * Perform an auth using a redirect-based sign-in flow.
       */
      doSignIn: function (privateRepoAccess) {
        var provider = new firebase.auth.GithubAuthProvider();
        provider.addScope('user');
        if (privateRepoAccess) {
          provider.addScope('repo');
        } else {
          provider.addScope('public_repo');
        }
        this.loading = true;
        this.$.auth.signInWithPopup(provider).then(this.checkSignedIn.bind(this));
      },

      /**
       * Check whether the redirect-flow was just finished.
       * In this case, parse the just obtained GitHub token and continue.
       * Otherwise, either the user was already signed in, or never signed in.
       * If the GitHub token is present in local-storage, we wait for firebase
       * to confirm the signin. If not, we notify that the user was not signed in.
       */
      checkSignedIn: function (result) {
        var redirectDone = !!result.credential;
        if (redirectDone) {
          this._parseSuccesfulResult(result);
        } else {
          if (this._tokens.GitHub) {
            this.waitingForSignIn = true;
          } else {
            this.fire('check-signed-in-failed');
          }
        }
        this.loading = false;
      },

      signOut: function() {
        this._setEmptyTokens();
        return this.$.auth.auth.signOut();
      },

      _onSignInChange: function(signedIn, statusKnown) {
        if (statusKnown) {
          if (signedIn) {
            this.fire('signed-in', this._tokens.GitHub);
          } else {
            this.fire('signed-out');
          }
        }
      },

      _parseSuccesfulResult: function(result) {
        var token = result.credential.accessToken;
        this.set('_tokens.GitHub', token);
        this.fire('github-token', token);
      },

      _setEmptyTokens: function() {
        this._tokens = {
          GitHub: ''
        };
      }
    });
  </script>
</dom-module>
