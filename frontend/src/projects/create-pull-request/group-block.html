<!--
@license
Copyright (c) 2017 Preview-Code. All rights reserved.
This code may only be used under the BSD style license found in LICENSE.txt
-->
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/drag-element/drag-element.html">
<link rel="import" href="../../../bower_components/drag-element/drag-element-styles.html">
<link rel="import" href="../diff/hunk-file-item.html">
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="group-block">
  <template>
    <style include="drag-element-styles">
      :host {
        display: block;
        width: 275px;
        flex-grow: 0;
        flex-shrink: 0;
      }

      .group {
        border-radius: 6px;
        background-color: var(--primary-background-color);
        height: 275px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      header {
        display: flex;
        background-color: var(--accent-color);
      }

      editable-title {
        padding: 0.5em;
        --edit-title-font-size: 1em;
        --edit-title-font-weight: 600;
        --edit-title-color: white;
        --edit-title-focus-color: white;
      }

      .hunks {
        position: relative;
        overflow-y: auto;
        flex: 1;
      }

      drag-element {
        display: block;
        height: 100%;
      }

      hunk-file-item {
        border-bottom: solid 1px var(--secondary-background-color);
      }

      hunk-file-item.mirror {
        border: dashed 1px var(--secondary-background-color);
        background-color: var(--primary-background-color);
        width: auto !important;
        height: auto !important;
      }

      hunk-file-item.shadow {
        opacity: 0.5;
      }

      .dragHandle {
        height: 28px;
        width: 28px;
        color: white;
        padding: 8px;
        cursor: -webkit-grabbing;
      }

      .removeBtn {
        display: none;
      }

      drag-element:empty + .removeBtn {
        display: initial;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>

    <paper-material class="group" elevation="2">
      <header>
        <iron-icon class="dragHandle" icon="editor:drag-handle"></iron-icon>
        <editable-title editable value="{{group.info.title}}"></editable-title>
      </header>
      <div class="hunks">
        <drag-element id="drag" link-identifier="group-editor">
        </drag-element>
        <paper-button raised class="removeBtn" on-tap="_removeGroup">
          <iron-icon icon="delete"></iron-icon>Remove
        </paper-button>
      </div>
    </paper-material>

  </template>
  <script>
    Polymer({
      is: 'group-block',

      observers: ['_onDiffChange(group.diff)'],

      properties: {
        group: {
          type: Object,
          notify: true
        },

        _cacheHunkElem: Object
      },

      listeners: {
        'drag-finish': '_add',
        'remove-hunk': '_remove'
      },

      attached: function () {
        this.$.drag.createShadow = this._createHunkItem.bind(this);
        this.$.drag.createDropElement = function () { return undefined };
      },

      _add: function (e) {
        e.stopPropagation();
        if (e.detail.source !== this.$.drag) {
          e.detail.source.fire('remove-hunk', e.detail);
          this.fire('add-hunk-to-group', {
            groupId: this.group.id,
            hunk: e.detail.dragElement.hunk,
            toIndex: e.detail.destElementIndex
          });
        } else {
          // Move element from sourceElementIndex to destElementIndex.
          this.fire('move-hunk', {
            groupId: this.group.id,
            fromIndex: e.detail.sourceElementIndex,
            toIndex: e.detail.destElementIndex
          })
        }
        this._onDiffChange(this.group.diff);
      },

      _remove: function (e) {
        e.stopPropagation();
        this.fire('remove-hunk-from-group', {
          groupId: this.group.id,
          hunk: e.detail.dragElement.hunk
        });
        this._onDiffChange(this.group.diff);
      },

      _removeGroup: function () {
        this.fire('remove-group', {
          groupId: this.group.id
        });
      },

      _onDiffChange: function (diff) {
        this.$.drag.innerHTML = '';
        diff.forEach(function (hunk) {
          var elem = document.createElement('hunk-file-item');
          elem.hunk = hunk;
          this.$.drag.appendChild(elem);
        }.bind(this));
      },

      _createHunkItem: function (draggedElem) {
        if (draggedElem.nodeName === 'HUNK-FILE-ITEM') {
          return draggedElem.cloneNode(true);
        }
        if (!this._cacheHunkElem) {
          this._cacheHunkElem = document.createElement('hunk-file-item');
        }
        this._cacheHunkElem.hunk = draggedElem.hunk;
        return this._cacheHunkElem;
      }
    });
  </script>
</dom-module>