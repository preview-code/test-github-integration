<!--
@license
Copyright (c) 2017 Preview-Code. All rights reserved.
This code may only be used under the BSD style license found in LICENSE.txt
-->
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../../bower_components/util/elements/list-item-label.html">
<link rel="import" href="../../ajax/backend-ajax.html">
<link rel="import" href="../project-behavior.html">

<dom-module id="pr-status">
  <template>
    <style>
      :host {
        display: block;
      }

      list-item-label {
        white-space: normal;
      }
    </style>
    <backend-ajax
      id="setPrStatus"
      refurl="[[backendPath]]"
    ></backend-ajax>

    <firebase-document
      app-name="preview-code"
      path="[[statusPath]]"
      on-data-changed="_updateRetrievedStatus"\
    ></firebase-document>

    <list-item-label type="box" title="status">[[status]]</list-item-label>
    <paper-dropdown-menu label="Set status" on-value-changed="_updateFirebaseStatus">
      <paper-menu id="statusList" class="dropdown-content" attr-for-selected="data-status">
        <template is="dom-repeat" items="[[statuses]]" index-as="index">
          <paper-item data-status="[[item]]">[[item]]</paper-item>
        </template>
      </paper-menu>
    </paper-dropdown-menu>
  </template>
  <script>
    /*global ProjectBehavior*/
    Polymer({
      is: 'pr-status',
      behaviors: [ProjectBehavior],
      properties: {
        statuses: {
          type: Array,
          value: function () {
            return ['No reviewer assigned', 'Awaiting reviewer response', 'Under review', 'Awaiting contributor response']
          }
        },
        status: {
          type: String,
          notify: true
        },
        sendStatus: String,
        pullRequest: Object,
        statusPath: {
          type: String,
          computed: '_updateStatusPath(pullRequest)'
        },
        backendPath: {
          type: String,
          computed: '_updateBackendPath(pullRequest)'
        }
      },
      observers: [
        '_setStatus(retrievedStatus)'
      ],
      _updateRetrievedStatus: function (e) {
        this.retrievedStatus = e.detail.value;
      },
      _updateStatusPath: function (pullRequest) {
        return '/' + pullRequest.base.repo.owner.login + '/' + pullRequest.base.repo.name + '/pulls/' + pullRequest.number + '/status';
      },
      _updateBackendPath: function (pullRequest) {
        return pullRequest.base.repo.owner.login + '/' + pullRequest.base.repo.name + '/pulls/' + pullRequest.number + '/status';
      },
      _updateFirebaseStatus: function (e) {
        if (!e.detail.value || typeof this.retrievedStatus === 'object'
          || e.detail.value === this.retrievedStatus || e.detail.value === this.status) {
          return;
        }
        this.status = e.detail.value;
        this.$.setPrStatus.body = {
          status: this.status
        };
        this.$.setPrStatus.generateRequest();
      },
      _setStatus: function (retrievedStatus) {
        if (typeof retrievedStatus !== 'object') {
          this.status = retrievedStatus;
          this.select(this.status);
        }
      },
      select: function (status) {
        this.$.statusList.select(status);
      }
    });
  </script>
</dom-module>